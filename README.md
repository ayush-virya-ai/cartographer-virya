# cartographer-virya

# Cartographer SLAM and Localization Package

This ROS 2 package provides a comprehensive solution for Simultaneous Localization and Mapping (SLAM) and pure localization using Google's Cartographer. It is configured for a robotic system equipped with a Velodyne VLP-16 LiDAR and an IMU sensor.

## Directory Structure

Here is an overview of the key directories and files in this package:

  * **`carto/`**: The root directory of the ROS 2 package.

      * **`CMakeLists.txt`**: The build script for the package, defining dependencies and executables.

      * **`package.xml`**: Contains meta-information about the package, including its name, version, and dependencies.

      * **`config/`**: Configuration files for Cartographer.

          * **`mapping.lua`**: Parameters for running Cartographer in mapping mode (i.e., building a new map).

          * **`localisation.lua`**: Parameters for running Cartographer in pure localization mode against a pre-existing map.

          * **`transformation.urdf.xacro`**: Defines the robot's physical structure and the spatial relationships (transforms) between its components, such as the base link, IMU, and LiDAR.

      * **`launch/`**: Launch files to start the SLAM and localization processes.

          * **`mapping.launch.py`**: Launches the nodes required for creating a new map.

          * **`localisation.launch.py`**: Launches the nodes required for localizing the robot within an existing map.

      * **`map/`**: Contains the pre-built map file.

          * **`my_map.pbstream`**: The saved map data generated by Cartographer.

      * **`rviz/`**: RViz configuration files for visualization.

          * **`rviz_config.rviz`**: A pre-set RViz layout for visualizing the robot, map, and sensor data.

      * **`src/`**: Source code for custom nodes.

          * **`initial_state.cpp`**: A C++ node that subscribes to an initial pose estimate and uses it to start a new trajectory in Cartographer for localization.

## Launch Files

This package includes two primary launch files for different modes of operation.

### Mapping (`mapping.launch.py`)

This launch file is used to start the SLAM process and create a new map of the environment. It launches the following nodes:

  * **`robot_state_publisher`**: Reads the `transformation.urdf.xacro` file, and publishes the transforms between the robot's different parts (e.g., `base_link` to `imu_link`).

  * **`cartographer_node`**: The main Cartographer node. In this launch file, it's configured using `mapping.lua` to process sensor data and build the map. It remaps the `points2` topic to `/velodyne_points` and the `imu` topic to `/imu/data`.

  * **`cartographer_occupancy_grid_node`**: Converts the 3D map created by Cartographer into a 2D occupancy grid, which is useful for navigation tasks.

  * **`rviz2`**: Starts the RViz visualization tool with the configuration specified in `rviz_config.rviz`.

To run the mapping process, use the following command:

```bash
ros2 launch carto mapping.launch.py
```

### Localization (`localisation.launch.py`)

This launch file is used for localizing the robot within the pre-existing `my_map.pbstream` map. It launches a similar set of nodes as the mapping launch file, but with a key difference in the Cartographer node's configuration:

  * **`cartographer_node`**: This time, it's configured using `localisation.lua`. This configuration file loads the existing map from `my_map.pbstream` and runs Cartographer in a pure localization mode, where the map is not updated.

To run the localization process, use the following command:

```bash
ros2 launch carto localisation.launch.py
```

## C++ Scripts

### `initial_state.cpp`

This C++ node, named `initial_point`, plays a crucial role in the localization process. Its primary function is to provide an initial pose estimate to Cartographer to help it determine the robot's starting position within the map.

Here's how it works:

1.  **Subscribes to `/initialpose`**: The node listens for a `geometry_msgs/msg/PoseWithCovarianceStamped` message on the `/initialpose` topic. This message is typically published from RViz using the "2D Pose Estimate" tool.

2.  **Calls Cartographer Services**:

      * Upon startup, it calls the `/finish_trajectory` service to end any previously running trajectories.

      * When it receives a message on `/initialpose`, it calls the `/start_trajectory` service, passing the received pose as the initial position for the new trajectory.

3.  **Shuts Down**: After successfully starting a new trajectory, the node shuts itself down as its task is complete.
